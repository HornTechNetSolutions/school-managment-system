// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  TEACHER
  STUDENT
  PARENT
  EMPLOYEE
}

enum Status {
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum EmployeeRole {
  PRINCIPAL
  VICE_PRINCIPAL
  ACCOUNTANT
  LIBRARIAN
  DRIVER
  NURSE
  SECURITY
  CLEANER
  IT_SUPPORT
  OFFICE_STAFF
}

model users {
  userUuid      String   @id @default(uuid())
  fullName      String
  email         String   @unique
  password      String
  role          Role
  status        Status   @default(ACTIVE)

  studentNumber String?  @unique
  employeeNumber String? @unique
  adminNumber String? @unique
  teacherNumber String? @unique

  student       student?
  teacher       teacher?
  parent        parent?
  admin         admin?
  employee      employee?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model student {
  studentUuid  String   @id @default(uuid())
  studentName  String  
  studentEmail String @unique
  studentNumber String @unique

  userUuid     String   @unique
  user         users     @relation(fields: [userUuid], references: [userUuid])
  
  parentUuid   String?
  parent       parent?  @relation(fields: [parentUuid], references: [parentUuid])

  classUuid    String?
  class        Class?   @relation(fields: [classUuid], references: [classUuid])

  submissions  AssignmentSubmission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model parent {
  parentUuid   String @id @default(uuid())
  parentName   String   
  parentEmail String @unique

  userUuid     String @unique
  user         users   @relation(fields: [userUuid], references: [userUuid])

  children     student[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model teacher {
  teacherUuid  String @id @default(uuid())
  teacherName  String  
  teacherEmail String @unique
  teacherNumber String @unique 

  userUuid     String @unique
  user         users   @relation(fields: [userUuid], references: [userUuid])

  // subject      String?
  classes      Class[]
  assignments  Assignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  AssignmentSubmission AssignmentSubmission[]

  TeacherSubject TeacherSubject[]
}

model admin {
  adminUuid  String @id @default(uuid())
  adminName  String 
  adminEmail String @unique
  adminNumber String @unique  

  userUuid   String @unique
  user       users   @relation(fields: [userUuid], references: [userUuid])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model employee {
  employeeUuid String @id @default(uuid())
  employeeName String  
  employeeEmail String @unique
  employeeNumber String @unique

  userUuid     String @unique
  user         users   @relation(fields: [userUuid], references: [userUuid])

  employeeRole EmployeeRole
  department   String?
  title        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Subject {
  subjectUuid String @id @default(uuid())
  name        String
  code        String?  @unique 

  classes     ClassSubject[]
  teachers    TeacherSubject[]
  Assignment Assignment[]
}

model Class {
  classUuid String @id @default(uuid())
  name      String
  grade     Int
  
  students   student[]
  assignments Assignment[]

  ClassSubject ClassSubject[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  teacher teacher[]
}

model ClassSubject {
  id         String @id @default(uuid())
  classUuid  String
  subjectUuid String

  class      Class   @relation(fields: [classUuid], references: [classUuid])
  subject    Subject @relation(fields: [subjectUuid], references: [subjectUuid])

  @@unique([classUuid, subjectUuid])
}

model TeacherSubject {
  id          String @id @default(uuid())
  teacherUuid String
  subjectUuid String

  teacher teacher  @relation(fields: [teacherUuid], references: [teacherUuid])
  subject Subject  @relation(fields: [subjectUuid], references: [subjectUuid])

  @@unique([teacherUuid, subjectUuid])
}

model Assignment {
  assignmentUuid String  @id @default(uuid())

  // Relations
  teacherUuid    String
  subjectUuid    String
  classUuid      String
  
  teacher       teacher @relation(fields: [teacherUuid], references: [teacherUuid])
  class          Class   @relation(fields: [classUuid], references: [classUuid])

  // Denormalized data (copied from Teacher & Class)
  teacherName    String     // ðŸ‘ˆ store teacher name directly
  className      String     // ðŸ‘ˆ store class name directly
  subject        Subject  @relation(fields: [subjectUuid], references: [subjectUuid])

  title          String
  description    String?
  dueDate        DateTime

  submissions    AssignmentSubmission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AssignmentSubmission {
  submissionUuid String @id @default(uuid())
  assignmentUuid String
  studentUuid    String
  content        String?
  fileUrl        String?
  score          Int?
  gradedByUuid   String?
  submittedAt    DateTime @default(now())
  gradedAt       DateTime?

  assignment Assignment @relation(fields: [assignmentUuid], references: [assignmentUuid])
  student    student    @relation(fields: [studentUuid], references: [studentUuid])
  gradedBy   teacher?   @relation(fields: [gradedByUuid], references: [teacherUuid])
}

// model refreshToken {
//   id     String @id @default(uuid())
//   token  String
//   userId String
//   user   User   @relation(fields: [userId], references: [id])
//   createdAt DateTime @default(now())
// }