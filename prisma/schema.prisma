// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  // !! MAKE SURE THERE IS NO 'output' LINE HERE !!
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


enum Role {
  ADMIN
  TEACHER
  STUDENT
  PARENT
  EMPLOYEE
}

enum Status {
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum ExamType {
  QUIZ
  MIDTERM
  FINAL
  TEST
  PROJECT
}

enum ResultStatus {
  DRAFT 
  PUBLISHED
  LOCKED
}

enum EmployeeRole {
  PRINCIPAL
  VICE_PRINCIPAL
  ACCOUNTANT
  LIBRARIAN
  DRIVER
  NURSE
  SECURITY
  CLEANER
  IT_SUPPORT
  OFFICE_STAFF
  REGISTRAR
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum FeeStatus {
  PENDING
  PARTIALLY_PAID
  PAID
}

enum Permission {
  MANAGE_STUDENTS
  MANAGE_ATTENDANCE
  MANAGE_FEES
  VIEW_REPORTS
  MANAGE_EXAMS
}

model users {
  userUuid      String   @id @default(uuid())
  fullName      String
  email         String   @unique
  password      String
  role          Role
  status        Status   @default(ACTIVE)

  student       student?
  teacher       teacher?
  parent        parent?
  admin         admin?
  employee      employee?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model student {
  studentUuid  String   @id @default(uuid())
  studentNumber String   @unique
  studentName   String
  studentEmail  String?

  userUuid String? @unique
  user users? @relation(fields: [userUuid], references: [userUuid])
  
  parentUuid   String?
  parent       parent?  @relation(fields: [parentUuid], references: [parentUuid])

  registeredByUuid String?
  registeredBy employee? @relation(fields: [registeredByUuid], references: [employeeUuid])

  classUuid    String?
  class        Class?   @relation(fields: [classUuid], references: [classUuid])

  submissions  AssignmentSubmission[]
  ExamResult ExamResult[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Attendance Attendance[]

  Fee Fee[]
}

model parent {
  parentUuid   String @id @default(uuid())
  parentName   String   
  parentEmail String @unique

  userUuid     String @unique
  user         users   @relation(fields: [userUuid], references: [userUuid])

  children     student[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model teacher {
  teacherUuid  String @id @default(uuid())
  teacherName  String  
  teacherEmail String @unique
  teacherNumber String @unique 

  userUuid     String @unique
  user         users   @relation(fields: [userUuid], references: [userUuid])

  subject      String?
  classes      Class[]
  assignments  Assignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  AssignmentSubmission AssignmentSubmission[]
  TeacherSubject TeacherSubject[]
  Exam Exam[]
  ExamResult ExamResult[]
}

model admin {
  adminUuid  String @id @default(uuid())
  adminName  String 
  adminEmail String @unique
  adminNumber String @unique  

  userUuid   String @unique
  user       users   @relation(fields: [userUuid], references: [userUuid])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model employee {
  employeeUuid String @id @default(uuid())
  employeeName String  
  employeeEmail String @unique
  employeeNumber String @unique

  userUuid     String @unique
  user         users   @relation(fields: [userUuid], references: [userUuid])

  employeeRole EmployeeRole
  department   String?
  title        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student student[]
}

model Subject {
  subjectUuid String @id @default(uuid())
  name        String
  code        String?  @unique
  grade       String?

  classes     ClassSubject[]
  teachers    TeacherSubject[]
  Assignment Assignment[]
  Exam Exam[]

  @@index([grade])
  @@index([name])
}

model Class {
  classUuid String @id @default(uuid())
  name      String
  grade     Int
  
  students   student[]
  assignments Assignment[]
  ClassSubject ClassSubject[]
   teacher teacher[]
  Exam Exam[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Attendance Attendance[]
}

model Exam {
  examUuid      String   @id @default(uuid())
  title         String
  description   String?
  examType      ExamType
  examDate      DateTime
  startTime     DateTime
  endTime       DateTime
  totalMarks    Int

  // Relations
  classUuid     String
  subjectUuid   String
  teacherUuid   String

  class         Class     @relation(fields: [classUuid], references: [classUuid])
  subject       Subject   @relation(fields: [subjectUuid], references: [subjectUuid])
  teacher       teacher   @relation(fields: [teacherUuid], references: [teacherUuid])

  results       ExamResult[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// model gradeScale {
//   id
//   minMarks
//   maxMarks
//   grade   
//   points 
// }

model ExamResult {
  resultUuid    String @id @default(uuid())
  examUuid      String
  studentUuid   String

  marksObtained Int?
  gradedByUuid  String?
  gradedAt      DateTime?
  comment       String?
  // status         ResultStatus @default(DRAFT)

  exam         Exam     @relation(fields: [examUuid], references: [examUuid])
  student      student  @relation(fields: [studentUuid], references: [studentUuid])
  gradedBy     teacher? @relation(fields: [gradedByUuid], references: [teacherUuid])

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([examUuid, studentUuid])
}

model ClassSubject {
  id         String @id @default(uuid())
  classUuid  String
  subjectUuid String

  class      Class   @relation(fields: [classUuid], references: [classUuid])
  subject    Subject @relation(fields: [subjectUuid], references: [subjectUuid])

  @@unique([classUuid, subjectUuid])
  @@index([classUuid])
  @@index([subjectUuid])
}

model TeacherSubject {
  id          String @id @default(uuid())
  teacherUuid String
  subjectUuid String

  teacher teacher  @relation(fields: [teacherUuid], references: [teacherUuid])
  subject Subject  @relation(fields: [subjectUuid], references: [subjectUuid])

  @@unique([teacherUuid, subjectUuid])
}

model Assignment {
  assignmentUuid String  @id @default(uuid())

  // Relations
  teacherUuid    String
  subjectUuid    String
  classUuid      String
  
  teacher       teacher @relation(fields: [teacherUuid], references: [teacherUuid])
  class          Class   @relation(fields: [classUuid], references: [classUuid])

  // Denormalized data (copied from Teacher & Class)
  teacherName    String     // ðŸ‘ˆ store teacher name directly
  className      String     // ðŸ‘ˆ store class name directly
  subject        Subject  @relation(fields: [subjectUuid], references: [subjectUuid])

  title          String
  description    String?
  dueDate        DateTime

  submissions    AssignmentSubmission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AssignmentSubmission {
  submissionUuid String @id @default(uuid())
  assignmentUuid String
  studentUuid    String
  content        String?
  fileUrl        String?
  score          Int?
  gradedByUuid   String?
  submittedAt    DateTime @default(now())
  gradedAt       DateTime?

  assignment Assignment @relation(fields: [assignmentUuid], references: [assignmentUuid])
  student    student    @relation(fields: [studentUuid], references: [studentUuid])
  gradedBy   teacher?   @relation(fields: [gradedByUuid], references: [teacherUuid])
}

model Attendance {
  attendanceUuid String @id @default(uuid())

  studentUuid String
  classUuid   String
  date        DateTime

  status      AttendanceStatus
  markedByUuid String? // teacher or employee
  markedAt    DateTime @default(now())

  student student @relation(fields: [studentUuid], references: [studentUuid])
  class   Class   @relation(fields: [classUuid], references: [classUuid])

  @@unique([studentUuid, date])
  @@index([classUuid, date])
}

model Fee {
  feeUuid     String @id @default(uuid())
  studentUuid String

  title       String
  amount      Float
  dueDate     DateTime
  status      FeeStatus @default(PENDING)

  student     student @relation(fields: [studentUuid], references: [studentUuid])
  payments    Payment[]

  createdAt   DateTime @default(now())
}

model Payment {
  paymentUuid String @id @default(uuid())
  feeUuid     String

  amount      Float
  method      String   // CASH, CARD, TRANSFER
  paidAt      DateTime @default(now())

  fee         Fee @relation(fields: [feeUuid], references: [feeUuid])
}

// model refreshToken {
//   id     String @id @default(uuid())
//   token  String
//   userId String
//   user   User   @relation(fields: [userId], references: [id])
//   createdAt DateTime @default(now())
// }